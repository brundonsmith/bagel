
from '../../lib/wrappers/core' import { iter }
from '../../lib/wrappers/local-storage' import { localStorage }
from '../../lib/wrappers/json' import { parse, stringify }

const lsKey = 'todo-list'

type TodoItem = {
    text: string,
    done: boolean
}

class TodoApp {
    public func memo render() =>
        <div>
            {iter<TodoItem>(this.items)
                .map<Element>(item =>
                    <div>
                        <input value={item.text} onChange={this.handleItemTextChange(item)}></input>
                        <input type={'checkbox'} checked={item.done} onChange={this.handleItemDoneChange(item)}></input>
                    </div>)
                .array()}

            <button onClick={this.addItem}>{'Add'}</button>
            <button onClick={this.clearDone}>{'Clear done'}</button>
        </div>

    visible items: TodoItem[] = (
        if (localStorage.getItem(lsKey) != nil) {
            parse(localStorage.getItem(lsKey))
        } else {
            []
        }
    )

    func memo handleItemTextChange(item: TodoItem) =>
        (e) {
            item.text = e.target.value;
        }

    func memo handleItemDoneChange(item: TodoItem) =>
        (e) {
            item.done = e.target.checked;
        }

    proc addItem() {
        this.items.push({ text: '', done: false });
    }

    proc clearDone() {
        this.items = iter<TodoItem>(this.items).filter(item => item.done == false).array();
    }
}

proc main() {
    let app = new TodoApp();

    autorun () {
        localStorage.setItem(lsKey, stringify(app.items, 0));
    }
    forever;

    autorun () {
        ___render(app.render());
    }
    forever;
}